apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Choosing to use master for argocd/applicationset to get fixes that aren't in
# the latest stable release (2.1.7):
# * https://github.com/argoproj-labs/applicationset/pull/370
# * https://github.com/argoproj/argo-cd/pull/7519
resources:
- namespace.yaml
- https://raw.githubusercontent.com/argoproj/argo-cd/master/manifests/install.yaml # TODO switch back to stable
- https://raw.githubusercontent.com/argoproj-labs/applicationset/master/manifests/install.yaml # TODO switch back to stable
- ingress.yaml
- bootstrap.yaml

patches:
- path: argocd-server-deployment-patch.yaml
- path: argocd-cm.yaml
- path: argocd-applicationset-controller-deployment-patch.yaml

patchesStrategicMerge:
- |-
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: argocd-applicationset-controller
  spec:
    template:
      spec:
        containers:
        - name: argocd-applicationset-controller
          command:
          - applicationset-controller
          - --policy create-only

namespace: argocd
